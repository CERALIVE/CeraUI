name: Build Distributions

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number for the build (e.g., 1.2.3)"
        required: true
        type: string
      release_notes:
        description: "Release notes (optional)"
        required: false
        type: string

jobs:
  build-ceraui-frontend-for-belabox:
    name: Build CeraUI Frontend for BELABOX
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CeraUI frontend for BELABOX
        run: ./scripts/build/build-ceraui-frontend-for-belabox.sh
        env:
          BUILD_VERSION: ${{ github.event.inputs.version }}

      - name: Upload frontend distribution
        uses: actions/upload-artifact@v4
        with:
          name: ceraui-frontend-for-belabox
          path: dist/belabox-frontend/

  build-ceraui-system:
    name: Build CeraUI Full System
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [arm64, amd64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CeraUI system distribution for ${{ matrix.architecture }}
        run: ./scripts/build/build-ceraui-system.sh
        env:
          BUILD_VERSION: ${{ github.event.inputs.version }}
          BUILD_ARCH: ${{ matrix.architecture }}

      - name: Upload compressed distribution (${{ matrix.architecture }})
        uses: actions/upload-artifact@v4
        with:
          name: ceraui-system-compressed-${{ matrix.architecture }}
          path: dist/compressed/

  build-debian-package:
    name: Build Debian Package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [arm64, amd64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Ruby and FPM
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-dev gcc g++
          sudo gem install fpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Debian package for ${{ matrix.architecture }}
        run: ./scripts/build/build-debian-package.sh
        env:
          BUILD_VERSION: ${{ github.event.inputs.version }}
          BUILD_ARCH: ${{ matrix.architecture }}

      - name: Upload Debian package (${{ matrix.architecture }})
        uses: actions/upload-artifact@v4
        with:
          name: ceraui-debian-package-${{ matrix.architecture }}
          path: dist/debian/

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs:
      [
        build-ceraui-frontend-for-belabox,
        build-ceraui-system,
        build-debian-package,
      ]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸ“¦ CeraUI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results:" >> $GITHUB_STEP_SUMMARY
          echo "- **CeraUI Frontend for BELABOX**: ${{ needs.build-ceraui-frontend-for-belabox.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CeraUI Full System**: ${{ needs.build-ceraui-system.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Debian Packages**: ${{ needs.build-debian-package.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Distributions Built:" >> $GITHUB_STEP_SUMMARY
          echo "1. **CeraUI Frontend for BELABOX** - For existing BELABOX devices with belaUI backend" >> $GITHUB_STEP_SUMMARY
          echo "2. **CeraUI System Archives** - Full system to replace belaUI or deploy on custom devices (arm64 and amd64)" >> $GITHUB_STEP_SUMMARY
          echo "3. **Debian Packages** - Easy installation packages for CeraUI system (arm64 and amd64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes:" >> $GITHUB_STEP_SUMMARY
          echo "${{ github.event.inputs.release_notes || 'No release notes provided' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "All build artifacts are available in the 'Artifacts' section of this workflow run." >> $GITHUB_STEP_SUMMARY
